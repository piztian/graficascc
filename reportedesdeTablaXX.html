<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte de Ventas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Estilos completos originales */
  </style>
</head>
<body>
<div class="container">
  <!-- Estructura completa del dashboard -->
</div>

<script>
// --- Código completo anterior ---
// Mejoras: gráficas ordenadas de mayor a menor y tabla ordenable por columnas.

let datos=[],filtros={sucursal:[]},charts={},ordenActual={col:null,asc:true};
const SHEET_ID='1eUY2A9N_nIahLkfjfvWssY5mH5Cv13PCEedJvUVVCxM';
const SHEET_NAME='TablaXX';

async function cargarDatos(){const err=document.getElementById('errorMsg'),load=document.getElementById('loading'),dash=document.getElementById('dashboard');
  try{const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
    const res=await fetch(url);
    if(!res.ok)throw new Error('No se pudo acceder a Google Sheets');
    const txt=await res.text();
    const ini=txt.indexOf('{'),fin=txt.lastIndexOf('}');
    if(ini<0||fin<0)throw new Error('Formato inválido');
    const json=JSON.parse(txt.substring(ini,fin+1));
    if(!json.table||!json.table.rows)throw new Error('Sin datos');
    datos=[];
    json.table.rows.forEach(r=>{if(!r.c||!r.c[0])return;
      datos.push({sucursal:r.c[0]?.v?.toString().trim()||'',
        producto:r.c[1]?.v?.toString().trim()||'',
        precio:+r.c[2]?.v||0,
        costo:+r.c[3]?.v||0,
        cantidad:+r.c[4]?.v||0,
        utilidad:+r.c[5]?.v||0,
        totalUtilidad:+r.c[8]?.v||0,
        porcUtilidad:+r.c[9]?.v||0});});
    if(!datos.length)throw new Error('La hoja está vacía');
    err.style.display='none';load.style.display='none';dash.style.display='block';
    actualizarDashboard();}catch(e){load.style.display='none';
    err.textContent='⚠️ '+e.message;
    err.style.display='block';}}function actualizarDashboard(){const f=datos;
  actualizarGraficos(f);
  actualizarTabla(f);}function actualizarGraficos(f){const map={};
  f.forEach(d=>{if(!map[d.sucursal])map[d.sucursal]={v:0,u:0};
    map[d.sucursal].v+=d.precio*d.cantidad;
    map[d.sucursal].u+=d.totalUtilidad;});
  // Ordenar de mayor a menor
  const arr=Object.entries(map).map(([s,v])=>({sucursal:s,ventas:v.v,utilidad:v.u}))
    .sort((a,b)=>b.ventas-a.ventas);
  const labels=arr.map(x=>x.sucursal);
  const ventasData=arr.map(x=>x.ventas);
  const utilData=arr.map(x=>x.utilidad);

  if(charts.v)charts.v.destroy();
  charts.v=new Chart(document.getElementById('chartVentas'),{type:'bar',
    data:{labels:labels,datasets:[{label:'Ventas',data:ventasData,backgroundColor:'#3b82f6'}]},
    options:{plugins:{legend:{labels:{color:'#e2e8f0'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}});

  if(charts.u)charts.u.destroy();
  // Ordenar utilidad también
  const arrU=[...arr].sort((a,b)=>b.utilidad-a.utilidad);
  charts.u=new Chart(document.getElementById('chartUtilidad'),{type:'bar',
    data:{labels:arrU.map(x=>x.sucursal),datasets:[{label:'Utilidad',data:arrU.map(x=>x.utilidad),backgroundColor:'#34d399'}]},
    options:{plugins:{legend:{labels:{color:'#e2e8f0'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}});}function actualizarTabla(f){const tbody=document.getElementById('tbodyVentas');
  tbody.innerHTML=f.map(d=>`
    <tr>
      <td class="sucursal-name">${d.sucursal}</td>
      <td>${d.producto}</td>
      <td>$${d.precio}</td>
      <td>$${d.costo}</td>
      <td>${d.cantidad}</td>
      <td>$${d.utilidad}</td>
      <td>$${d.totalUtilidad}</td>
      <td>${d.porcUtilidad.toFixed(1)}%</td>
    </tr>
  `).join('');
  hacerSortable();}function hacerSortable(){document.querySelectorAll('th').forEach((th,i)=>{th.style.cursor='pointer';
    th.onclick=()=>ordenarPorColumna(i);});}function ordenarPorColumna(i){const tbody=document.getElementById('tbodyVentas');
  const filas=[...tbody.querySelectorAll('tr')];
  const asc=ordenActual.col===i?!ordenActual.asc:true;
  filas.sort((a,b)=>{const tA=a.children[i].innerText.replace(/[^0-9.-]+/g,'');
    const tB=b.children[i].innerText.replace(/[^0-9.-]+/g,'');
    const nA=parseFloat(tA)||tA.toLowerCase();
    const nB=parseFloat(tB)||tB.toLowerCase();
    if(nA<nB)return asc?-1:1;
    if(nA>nB)return asc?1:-1;
    return 0;});
  ordenActual={col:i,asc:asc};
  tbody.innerHTML='';
  filas.forEach(f=>tbody.appendChild(f));}window.addEventListener('load',cargarDatos);
</script>
</body>
</html>
